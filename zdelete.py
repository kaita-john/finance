import sqlite3
import time
import vimeo

VIMEO_ACCESS_TOKEN = "17067378d4977fa10bb0f58f0dd3382c"
client = vimeo.VimeoClient(token=VIMEO_ACCESS_TOKEN)


def log_failed_deletion(video_id, video_name, language_code):
    conn = sqlite3.connect("saved_videos.db")
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS failed_deletions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            video_id TEXT,
            video_name TEXT,
            language TEXT,
            timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    """)
    cursor.execute("""
        INSERT INTO failed_deletions (video_id, video_name, language)
        VALUES (?, ?, ?)
    """, (video_id, video_name, language_code))
    conn.commit()
    conn.close()
    print(f"‚ùå Logged failed deletion: {video_name} [{language_code}]")


def get_video_name(video_id):
    response = client.get(f"/videos/{video_id}")
    if response.status_code != 200:
        raise Exception(f"Failed to fetch video data. Status: {response.status_code}")
    return response.json()["name"]


def get_text_tracks(video_id):
    response = client.get(f"/videos/{video_id}/texttracks")
    if response.status_code != 200:
        raise Exception(f"Failed to fetch text tracks. Status: {response.status_code}")
    return response.json().get("data", [])


def delete_caption(track_uri):
    response = client.delete(track_uri)
    return response.status_code == 204


def delete_subtitles_for_video(video_id):
    try:
        video_name = get_video_name(video_id)
        print(f"\nüéûÔ∏è Processing video: {video_name} (ID: {video_id})")

        tracks = get_text_tracks(video_id)
        languages_to_delete = ["fr", "pt", "zh"]
        deleted_any = False

        for track in tracks:
            lang = track.get("language")
            uri = track.get("uri")
            type_ = track.get("type")

            if lang in languages_to_delete and type_ == "subtitles":
                print(f"üóëÔ∏è Found {lang} subtitles: Attempting deletion...")
                if delete_caption(uri):
                    print(f"‚úÖ Deleted {lang} subtitles.")
                    deleted_any = True
                    time.sleep(2)  # Small pause for safety
                else:
                    print(f"‚ùå Failed to delete {lang} subtitles.")
                    log_failed_deletion(video_id, video_name, lang)

        if not deleted_any:
            print("‚ÑπÔ∏è No matching subtitles found to delete.")
    except Exception as e:
        print(f"‚ùå Error processing video {video_id}: {e}")
        log_failed_deletion(video_id, "UNKNOWN", "general")


def bulk_delete_subtitles(video_list):
    total = len(video_list)
    success = 0
    failed = 0

    for index, video_id in enumerate(video_list, start=1):
        print(f"\n--- [{index}/{total}] Starting subtitle cleanup for Video ID: {video_id} ---")
        try:
            delete_subtitles_for_video(video_id)
            success += 1
        except Exception as e:
            print(f"‚ö†Ô∏è Exception during processing: {e}")
            failed += 1

    print("\n======================= SUMMARY =======================")
    print(f"üé¨ Total videos given: {total}")
    print(f"‚úÖ Successfully processed: {success}")
    print(f"‚ùå Failed: {failed}")
    print("=======================================================")


# üìù EXAMPLE USAGE
video_ids = [
    1023990820, 242120638, 1013867720, 1032028999, 367873297, 369483788, 1027848760, 1032486745,
    1023990795, 1024834857, 369482902, 1023990714, 1023990761, 1024032806, 1024032767, 1024032786,
    1024032746, 1062084540, 1024833624, 1013867702, 1024917797, 1025334509, 1027843183, 1028475495,
    1028550630, 128160645, 233392278, 238990232, 139212629, 139212654, 238510314, 139212669,
    490588404, 492324901, 492339249, 496245897, 496035857, 958736985, 594867278, 594869947,
    594890118, 594881666, 594886125, 586802833, 586799490, 598421957, 602856862, 292441530,
    292441299, 599056178, 599050072, 353016701, 354250149, 353136652, 603403596, 603329176,
    603393354, 236997083, 157346909, 236997370, 236993877, 236996175, 675003397, 234439526,
    139513902, 234602318, 234439906, 139513929, 675004660, 293225155, 296566777, 291835776,
    968943167, 968950322, 968946881, 968941883, 139513894, 139693282, 139513862, 669468788,
    669489783, 145857446, 240206751, 970997252, 241113643, 241112334, 358427754, 358428813,
    358428216, 371029673, 129483392, 139693198, 238463591, 238502474, 241773715, 674213863,
    674214658, 674215060, 674214202, 139693229, 500170838, 500166437, 292809079, 292808699,
    299063819, 299064574, 299061626, 299798052, 299798638, 299797602, 302962458, 139693216,
    139786064, 286083204, 299064131, 289960077, 291811521, 290997125, 129483393, 129483391,
    310417417, 295236997, 139786099, 139786044, 139786048, 139786053, 139786055, 139786056,
    139786058, 142018360, 139836981, 371973119, 139693294, 403793945, 135508844, 296567692,
    717121560, 296738434, 1020734428, 1030871252, 139836912, 299797127, 358657107, 798209421,
    233390936, 355247410, 139693220, 139693250, 139786067, 139786069, 328295967, 355170416,
    296933977, 358656598, 142018467, 139513915, 128745978, 142131427, 139836977, 139836984,
    139836986, 145857340, 299060157, 296564342, 296565764, 299063066, 296567340, 296564739,
    452674546, 505301482, 142018474, 139836925, 139836973, 139786082, 139786078, 139838463,
    139838458, 139838480, 139838475, 356989258, 834442896, 1030845725, 799295097, 142018311,
    952080877, 139836989, 299058339, 373452558, 373451158, 353136867, 353017832, 142493145,
    142493155, 142493163, 142493169, 139786062, 299065162, 299061070, 343131844, 135460526,
    353677941, 510825392, 299762336, 1029017140, 299762188, 139693340, 135508843, 139693329,
    139693323, 135511498, 139693352, 142018337, 134374780, 139838484, 375292050, 241530637,
    299327715, 142018390, 142018327, 142018321, 299062409, 452672923, 142018353, 142018357,
    319098948, 757316148, 142018419, 142018460, 142018380, 142018385, 142018344, 241532418,
    420725222, 601538854, 128700242, 128700245, 148680806, 138541442, 148796397, 148796400,
    142440015, 142439980, 142439985, 142439989, 232739653, 134541449, 142440180, 142493198,
    142493205, 325694453, 142493211, 142493215, 425171760, 425174838, 425177422, 425172885,
    1032130885, 481806690, 145688328, 130997483, 145688304, 145688306, 145688316, 145688325,
    137036232, 142018401, 142018400, 142018413, 142018412, 449112409, 500645196, 142131418,
    142018426, 142018432, 142018437, 142131430, 142131441, 142131494, 142131509, 145796469,
    142131521, 142131474, 343132131, 146233094, 687499103, 322520773, 319101755, 142131362,
    142131402, 142131407, 142131417, 500488192, 503662069, 145687994, 157650350, 157650349,
    159518290, 374503750, 370328661, 865711688, 333585722, 315522033, 1012868061, 333583288,
    145857253, 142440019, 142440139, 142440147, 134541446, 134541444, 142440144, 127757008,
    137059661, 145857455, 241431389, 142131464, 142131453, 145857261, 142131490, 146233091,
    142131540, 142131550, 142131565, 142131529, 142131422, 145857271, 146233329, 146233096,
    155205084, 800911415, 155000835, 319102302, 353015443, 428845446, 145688422, 148680819,
    145688001, 145688121, 146233371, 159518289, 159518288, 160381059, 166435808, 166400450,
    166400448, 657605099, 148680817, 148796403, 866007798, 142493184, 142493187, 142493188,
    142440188, 142440190, 145688322, 338477335, 309368109, 142440164, 145796464, 145857166,
    145857168, 145857174, 145857175, 145857178, 145857182, 806186510, 806188556, 142131571,
    142131575, 142131584, 142439975, 145857430, 146233235, 146233239, 146233243, 146233254,
    146233249, 146233256, 146233258, 336614771, 359309789, 150786782, 150832572, 367459249,
    242138352, 441690682, 874846468, 874842584, 874849348, 166400452, 166400461, 166400449,
    166873668, 166400457, 357138737, 166400445, 166400441, 166400447, 166367297, 166400440,
    166400443, 166400439, 148680824, 148680835, 393538997, 385295112, 352853404, 352853271,
    352854182, 352852780, 352849991, 352849865, 352849632, 352847744, 352813709, 352815214,
    352847242, 352838162, 352840972, 352841425, 395529087, 395876171, 396035871, 397030575,
    419433391, 422948675, 387295949, 342301812, 342303314, 342304399, 341904803, 325760243,
    324904261, 331812534, 324903594, 327635426, 324640902, 326074995, 251735116, 909730555,
    142493141, 657617532, 503917424, 146233364, 331577724, 146233362, 146233350, 146233348,
    146233344, 146233337, 366123020, 146233333, 146233320, 146233317, 146233313, 146233264,
    136681506, 128425656, 128425654, 128425653, 394560707, 319102877, 455780528, 466423928,
    145857249, 145857214, 145857205, 145857193, 145857189, 145857185, 128425650, 128425649,
    128276659, 128160647, 148796409, 148796407, 343136904, 145908249, 145857260, 128700244,
    311600068, 148743153, 145796467, 142493113, 142440209, 562500785, 392534484, 392141293,
    392143044, 148680849, 148743147, 148680838, 374502316, 319099513, 348507890, 315050674,
    319310180, 315567078, 315565985, 332078985, 332078366, 332080302, 328016264, 328018557,
    322519891, 148796411, 148796422, 126961433, 680283862, 328297298, 209638798, 139664214,
    142493372, 142493367, 419363815, 506321214, 505760408, 657616227, 450061133, 449894696,
    406407145, 364885294, 364887708, 364815916, 364818488, 362885841, 362878423, 362875820,
    130655875, 130655887, 130655869, 139664213, 139339170, 142493386, 145687985, 142493380,
    142493369, 142493360, 142493342, 142493356, 142493336, 142493326, 142493321, 142493317,
    142493293, 827112417, 148743148, 312828560, 163497683, 163497709, 163497685, 142493124,
    132126894, 142439884, 142439907, 142439904, 142439872, 142439895, 286254515, 132126895,
    132126896, 311080574, 311080190, 311079848, 286082808, 286251691, 286248704, 311080762,
    285415047, 286082266, 285414803, 284177722, 286963969, 286082184, 284178506, 286964327,
    286082447, 286964245, 385575781, 302537368, 282906341, 299035863, 272256508, 272853440,
    272608596, 272570778, 272893135, 272053067, 272694639, 272055356, 272052647, 272055701,
    272604978, 272026299, 272030132, 272030637, 272032499, 272031690, 272025467, 272016564,
    271799759, 271800283, 271961683, 272585650, 272606840, 272255957, 272579997, 272581424,
    272572672, 272589510, 272010414, 272012973, 272010256, 272009989, 272568216, 272569883,
    272604186, 272009562, 272571668, 272604493, 271694100, 272568708, 272000511, 272005180,
    272002602, 272016336, 272587823, 271488877, 271491033, 271493318, 271494743, 272603620,
    273127757, 271384520, 271383966, 271383109, 271359536, 271360504, 271212134, 271291728,
    271164627, 271173385, 272607482, 272660236, 271395417, 271000606, 271391345, 271389646,
    183936605, 183936606, 245786163, 245461378, 245460927, 191712101, 190039892, 189160433,
    189160432, 207655887, 205736597, 205737829, 202663519, 201234952, 201237364, 194888720,
    193785091, 194765930, 194766607, 193491368, 193491255, 192185689, 193489937, 190039893,
    186198690, 186027931, 185586491, 185586492, 185338834, 185338835, 184797095, 184370254,
    183936589, 190966027, 190966970, 183936583, 197959195, 183936588, 183936586, 207865670,
    183936581, 183936591, 183936592, 183936590, 184354478, 183936598, 187685853, 194844063,
    183936601, 183936593, 183936595, 183936596, 183936594, 183936602, 183936604, 183936603,
    654223597, 1035678950, 427967084, 813883734, 424374299, 481940010, 481802702, 445415896,
    446878833, 446880764, 781226303, 781275224, 781524265, 1035679024, 148796272, 148796270,
    148796363, 148796353, 148743430, 148743426, 148743421, 148743420, 148743413, 145796459,
    145688432, 148796258, 148796342, 148796348, 148796339, 148796337, 148796334, 148796331,
    148796327, 148796322, 148796317, 148796312, 148796257, 148796251, 148796252, 148796250,
    148796237, 148796233, 148796213, 148796211, 148796197, 148796195, 148796191, 148743513,
    148743511, 148743501, 148743498, 148743302, 148743277, 148743273, 148743270, 148743263,
    148743260, 148743258, 148743251, 148743248, 148743241, 148743234, 148743233, 148743236,
    148743230, 148743197, 148743200, 148743182, 148743179, 148743173, 148743166, 148743168,
    148743494, 148743472, 148743457, 148743455, 148743451, 148743447, 148743442, 148743437,
    148743435, 148743399
]  # Replace with your actual list

bulk_delete_subtitles(video_ids)
